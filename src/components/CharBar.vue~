<script setup lang="ts">
import { Chart as ChartJS, ArcElement, Tooltip, Legend, Title } from "chart.js";
import { Doughnut } from "vue-chartjs";

ChartJS.register(ArcElement, Tooltip, Legend, Title);

const rawData = [20, 20, 80, 20]; // Исходные данные
const labels = ["VueJs", "EmberJs", "ReactJs", "AngularJs"];
const backgroundColors = ["#41B883", "#E46651", "#00D8FF", "#DD1B16"];

const data = {
  labels,
  datasets: [
    {
      backgroundColor: backgroundColors,
      data: rawData,
    },
  ],
};

const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  cutout: 100,
  rotation: 0,
  circumference: 360,
  animation: {
    animateRotate: true,
    animateScale: true,
  },
  plugins: {
    legend: {
      display: false, // Отключаем стандартную легенду
    },
  },
};

// Кастомный плагин для добавления кастомных процентов
const customLegendPlugin = {
  id: "customLegend",
  afterDraw(chart) {
    const { ctx, chartArea, _metasets } = chart;
    const meta = _metasets[0]; // Метаданные для первого набора данных
    const centerX = (chartArea.left + chartArea.right) / 2;
    const centerY = (chartArea.top + chartArea.bottom) / 2;
    const radius = meta.data[0].outerRadius; // Радиус диаграммы

    ctx.save();

    // Рендерим каждую метку рядом с соответствующим сектором
    meta.data.forEach((arc, index) => {
      const angle = (arc.startAngle + arc.endAngle) / 2; // Средний угол сектора
      const labelX = centerX + Math.cos(angle) * (radius + 20); // Позиция текста
      const labelY = centerY + Math.sin(angle) * (radius + 20);

      // Вычисляем процент для текущего сектора
      const percentage = chart.data.datasets[0].data[index];

      // Рисуем кружок метки
      ctx.fillStyle = chart.data.datasets[0].backgroundColor[index];
      ctx.beginPath();
      ctx.arc(labelX, labelY, 6, 0, 2 * Math.PI);
      ctx.fill();

      // Рисуем текст с процентами
      ctx.font = "12px Arial";
      ctx.fillStyle = "#000";
      ctx.textAlign = labelX > centerX ? "left" : "right"; // Текст слева или справа
      ctx.textBaseline = "middle";
      ctx.fillText(`${percentage}%`, labelX + 10, labelY);
    });

    ctx.restore();
  },
};
</script>

<template>
  <Doughnut
    id="my-chart-id"
    :options="chartOptions"
    :data="data"
    :plugins="[customLegendPlugin]"
  />
</template>
